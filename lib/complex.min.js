/* Copyright (c) 2012 Patrick Roberts */(function(e){"use strict";function E(e){return e>=0?e-e%1:e-(1+e%1)%1}function S(e){return e>=0?e+(1-e%1)%1:e-e%1}function x(e){return E(e+.5)}function T(e){return e-e%1}function N(e){return e%1}function C(e,t,r,s){if(!(this instanceof C)){return new C(e,t,r,s)}if(typeof r==="number"){this.m=n.abs(r)}else{this.m=n.sqrt(e*e+t*t)}if(typeof s==="number"){this.t=r>=0?s:s+i}else{this.t=n.atan2(t,e)}this.t=i-(i*3-(i-(i*3-this.t)%(i*2)))%(i*2);this.r=e;this.i=t}function k(e,t,n){var r;if(v.test(e)){if(m.test(n.slice(t))){return e}return e.charAt(0).replace(a,k)+"*"+e.charAt(1).replace(a,k)}if(p.test(e)){return"("}if(d.test(e)){return")"}r=e.search(g);return e.charAt(r!==-1?r:"*")}function L(e){var t=/[^a-z]+/gi,n="abcdefghijklmnopqrstuvwxyz",r=n.length,i={},s="",o,u,a;e=e.map(function(e){var n=e.replace(t,"");if(!n){throw new SyntaxError('"'+e+'" is an invalid variable name.')}return n.toLowerCase()});for(o=0;o<e.length;o++){u=o;while(u>=0){a=u%r;u=u-a;s=n.charAt(a)+s;u=u/r-1}i[e[o]]=s;s=""}return i}function A(e,t){var n=1;while(n>0&&t<e.length){if(e[t]==="("){n++}if(e[t]===")"){n--}t++}return t}function O(e,t){var n=0,r;for(r=t;r<e.length;r++){if(e[r]==="("){n++}else if(e[r]===")"){n--}if(n<0){return r}if(n===0){if(e[r]==="+"||e[r]==="-"&&!b[e[r-1]]){return r}}}return e.length}function M(e,t){var n=0,r;for(r=t;r<e.length;r++){if(e[r]==="("){n++}else if(e[r]===")"){n--}if(n<0){return r}if(n===0){if(e[r]==="+"||e[r]==="-"&&!b[e[r-1]]){return r}if(e[r]==="*"||e[r]==="/"||e[r]===" "||e[r]==="%"){return r}}}return e.length}function _(e,t,n){switch(e){case"+":case"-":return O(t,n);case"*":case" ":case"/":case"%":case"^":return M(t,n);default:throw new SyntaxError('"'+e+'" is not a valid operator.')}}function D(){Array.apply(this,arguments)}function P(e,t,n){var r="",i=0,s=false,o,u,a,p,d,v,m;while(i<e.length){if(!s&&e.substr(i,2)!=="e^"&&e.substr(i).search(l)===0){o=e.substr(i).match(l)[0];u=w[o]||t[o];if(!u){throw new ReferenceError('"'+o+'" is not a valid variable.')}r+=u;i+=o.length;s=true}else if(!s&&e.substr(i).search(f)===0){o=e.substr(i).match(f)[0];a=y[o];switch(o){case"-":m=O(e,i+o.length);break;case"e^":m=M(e,i+o.length);break;default:m=A(e,i+o.length);break}if(!a){o=o.substr(0,o.length-1);if(!(w[o]||t[o])){throw new ReferenceError('"'+o+'(" is not a valid function.')}e=e.substr(0,i)+o+"*("+e.substr(i+o.length+1)}else{r+=a==="("?"":a;i+=o.length;r+=P(e.substring(i,m),t,n)+(a==="("?"":")");i=e[m]===")"?m+1:m;s=true}}else if(s&&e.substr(i).search(c)===0){o=e.substr(i).match(c)[0];p=b[o];v=e.substr(i+1).search(h)===0&&e.substr(i+1).match(h)[0];m=_(o,e,i+o.length+(v?v.length:0));if(!p){throw new SyntaxError('"'+o+'" is not a valid operator.')}r+=p;i+=o.length;r+=P(e.substring(i,m),t,n)+")";i=e[m]===")"?m+1:m;s=true}else if(!s&&e.substr(i).search(h)===0){o=e.substr(i).match(h)[0];d=parseFloat(o);if(isNaN(d)){throw new TypeError('"'+o+'" is not a valid number.')}r+="this["+n.push(new C(d,0,d,0))+"]";i+=o.length;s=true}else{throw new SyntaxError('Unexpected character "'+e.charAt(i)+'".')}}return r}var t=e,n=t.Math,r=t.Number,i=n.PI,s,o=[],u,a=/(?:\d[a-z\{\[\(]|[\}\]\)][a-z\d])|(?:[\{\}\[\]]| *[\+\-\*\/\^ %] *)/gi,f=/[a-z]*\(|(?:-|e\^)\(?/i,l=/[a-z]+(?![a-z]*\()/i,c=/[\+\-\*\/\^ %]/,h=/(?:(?:\d*\.\d+|\d+\.\d*)|\d+)(?:e(?:[\-+]|)\d+(?!\d*\.)|)/i,p=/\{|\[/,d=/\}|\]/,v=/\d[a-z\{\[\(]|[\}\]\)][a-z\d]/i,m=/(?:(?:\d*\.\d+|\d+\.\d*)|\d+)e(?:[\-+]|)\d+(?!\d*\.)/i,g=/[\+\-\*\/\^%]/,y={"(":"(","sqrt(":"C.sqrt(","cbrt(":"C.cbrt(","exp(":"C.exp(","e^(":"C.exp(","e^":"C.exp(","log(":"C.log(","ln(":"C.log(","gamma(":"C.gamma(","fact(":"C.fact(","factorial(":"C.fact(","sin(":"C.sin(","cos(":"C.cos(","tan(":"C.tan(","sec(":"C.sec(","csc(":"C.csc(","cot(":"C.cot(","arcsin(":"C.arcsin(","arccos(":"C.arccos(","arctan(":"C.arctan(","arcsec(":"C.arcsec(","arccsc(":"C.arccsc(","arccot(":"C.arccot(","arsin(":"C.arcsin(","arcos(":"C.arccos(","artan(":"C.arctan(","arsec(":"C.arcsec(","arcsc(":"C.arccsc(","arcot(":"C.arccot(","asin(":"C.arcsin(","acos(":"C.arccos(","atan(":"C.arctan(","asec(":"C.arcsec(","acsc(":"C.arccsc(","acot(":"C.arccot(","sinh(":"C.sinh(","cosh(":"C.cosh(","tanh(":"C.tanh(","sech(":"C.sech(","csch(":"C.csch(","coth(":"C.coth(","arcsinh(":"C.arcsinh(","arccosh(":"C.arccosh(","arctanh(":"C.arctanh(","arcsech(":"C.arcsech(","arccsch(":"C.arccsch(","arccoth(":"C.arccoth(","arsinh(":"C.arcsinh(","arcosh(":"C.arccosh(","artanh(":"C.arctanh(","arsech(":"C.arcsech(","arcsch(":"C.arccsch(","arcoth(":"C.arccoth(","asinh(":"C.arcsinh(","acosh(":"C.arccosh(","atanh(":"C.arctanh(","asech(":"C.arcsech(","acsch(":"C.arccsch(","acoth(":"C.arccoth(","-":"C.neg(","-(":"C.neg(","re(":"C.re(","real(":"C.re(","im(":"C.im(","imag(":"C.im(","abs(":"C.abs(","mag(":"C.abs(","arg(":"C.arg(","conj(":"C.conj(","norm(":"C.norm(","normal(":"C.norm(","floor(":"C.floor(","ceil(":"C.ceil(","ceiling(":"C.ceil(","round(":"C.round(","fpart(":"C.fPart(","frac(":"C.fPart(","ipart(":"C.iPart(","int(":"C.iPart("},b={"+":".add(","-":".sub(","*":".mult("," ":".mult(","/":".divBy(","%":".mod(","^":".pow("},w={e:"C.E",i:"C.I",pi:"C.PI"};if(n.sinh===undefined){n.sinh=function(e){return(-n.exp(-e)+n.exp(e))/2}}if(n.cosh===undefined){n.cosh=function(e){return(n.exp(-e)+n.exp(e))/2}}if(r.EPSILON===undefined){r.EPSILON=2.220446049250313e-16}s=new C(n.sqrt(2*i),0,n.sqrt(2*i),0);u=[.9999999999998099,676.5203681218851,-1259.1392167224028,771.3234287776531,-176.6150291621406,12.507343278686905,-.13857109526572012,9984369578019572e-21,1.5056327351493116e-7].map(function(e,t){o.push(new C(t,0,t,0));return new C(e,0,n.abs(e),e<0?i:0)});C.ZERO=new C(0,0,0,0);C.ONE=new C(1,0,1,0);C.I=new C(0,1,1,i/2);C.NEG_I=new C(0,-1,1,3*i/2);C.PI=new C(i,0,i,0);C.E=new C(n.E,0,n.E,0);C.TWO=new C(2,0,2,0);C.TWO_I=new C(0,2,2,i/2);C.Polar=function(e,t){return new C(e*n.cos(t),e*n.sin(t),e,t)};C.prototype.toString=function(e){var t,r,i,s;if(!C.isFinite(this)){return"Infinity"}if(C.isNaN(this)){return"NaN"}if(e){t=this.r.toPrecision().toUpperCase();r=this.i.toPrecision().toUpperCase();if(this.i===0){return t}if(this.r===0){return n.abs(this.i)===1?this.i>0?"i":"-i":r+" i"}return t+(this.i>0?"+":"")+(n.abs(this.i)===1?this.i>0?"i":"-i":r+" i")}i=this.m.toPrecision().toUpperCase();s=this.t.toPrecision().toUpperCase();if(this.m===0||this.t===0){return i}return i+" e^("+s+" i)"};C.prototype.equals=function(e){var t=this.r,i=this.i,s=this.m,o=this.t,u=e.r,a=e.i,f=e.m,l=e.t,c=n.abs(t-u)<=n.max(n.abs(t),n.abs(u))*r.EPSILON,h=n.abs(i-a)<=n.max(n.abs(i),n.abs(a))*r.EPSILON,p=n.abs(s-f)<=n.max(n.abs(s),n.abs(f))*r.EPSILON,d=n.abs(o-l)<=n.max(n.abs(o),n.abs(l))*r.EPSILON;return c&&h||p&&d};C.prototype.re=C.prototype.real=function(){return this.r};C.prototype.im=C.prototype.imag=function(){return this.i};C.prototype.abs=C.prototype.mag=function(){return this.m};C.prototype.arg=C.prototype.angle=function(){return this.t};C.prototype.rAdd=function(e){return new C(this.r+e,this.i)};C.prototype.add=function(e){return new C(this.r+e.r,this.i+e.i)};C.prototype.rSub=function(e){return new C(this.r-e,this.i)};C.prototype.sub=function(e){return new C(this.r-e.r,this.i-e.i)};C.prototype.rMult=function(e){return C.Polar(this.m*e,this.t)};C.prototype.mult=function(e){return C.Polar(this.m*e.m,this.t+e.t)};C.prototype.rDivBy=function(e){return C.Polar(this.m/e,this.t)};C.prototype.divBy=function(e){return C.Polar(this.m/e.m,this.t-e.t)};C.prototype.rMod=function(e){return new C(e===0?0:this.r%e,this.i)};C.prototype.mod=function(e){return new C(e.r===0?0:this.r%e.r,e.i===0?0:this.i%e.i)};C.prototype.rPow=function(e){if(e===2){return C.square(this)}if(e===3){return C.cube(this)}return C.Polar(n.pow(this.m,e),this.t*e)};C.prototype.pow=function(e){if(e.i===0){return this.rPow(e.r)}return C.Polar(n.pow(this.m,e.r)*n.exp(-e.i*this.t),e.i*n.log(this.m)+e.r*this.t)};C.neg=function(e){return new C(-e.r,-e.i,e.m,e.t+i)};C.re=function(e){return new C(e.r,0,n.abs(e.r),e.r<0?i:0)};C.im=function(e){return new C(e.i,0,n.abs(e.i),e.i<0?i:0)};C.abs=function(e){return new C(e.m,0,e.m,0)};C.arg=function(e){return new C(e.t,0,n.abs(e.t),e.t<0?i:0)};C.conj=function(e){return new C(e.r,-e.i,e.m,(i*2-e.t)%i*2)};C.norm=function(e){return C.Polar(e.m/e.m,e.m===0?0:e.t)};C.floor=function(e){return new C(E(e.r),E(e.i))};C.ceil=function(e){return new C(S(e.r),S(e.i))};C.round=function(e){return new C(x(e.r),x(e.i))};C.iPart=function(e){return new C(T(e.r),T(e.i))};C.fPart=function(e){return new C(N(e.r),N(e.i))};C.square=function(e){return new C(e.r*e.r-e.i*e.i,2*e.r*e.i,e.m*e.m,e.t*2)};C.cube=function(e){return new C(e.r*e.r*e.r-3*e.r*e.i*e.i,3*e.r*e.r*e.i-e.i*e.i*e.i,e.m*e.m*e.m,e.t*3)};C.sqrt=function(e){return e.rPow(.5)};C.cbrt=function(e){return e.rPow(1/3)};C.exp=function(e){return e.i===0?C.E.rPow(e.r):C.Polar(n.exp(e.r),e.i)};C.log=function(e){return new C(n.log(e.m),e.t)};C.gamma=function(e){var t,n,r,i;if(e.r<.5){return C.PI.divBy(C.sin(C.PI.mult(e)).mult(C.gamma(C.ONE.sub(e))))}t=e.sub(C.ONE);n=u[0];for(r=1;r<9;r++){n=n.add(u[r].divBy(t.add(o[r])))}i=t.add(new C(7.5,0,7.5,0));return s.mult(i.pow(t.add(new C(.5,0,.5,0)))).mult(C.exp(C.neg(i))).mult(n)};C.fact=function(e){return C.gamma(e.add(C.ONE))};C.cos=function(e){var t=e.mult(C.I);return C.exp(t).add(C.exp(C.neg(t))).divBy(C.TWO)};C.sin=function(e){var t=e.mult(C.I);return C.exp(t).sub(C.exp(C.neg(t))).divBy(C.TWO_I)};C.tan=function(e){var t=e.mult(C.I),n=C.exp(t),r=C.exp(C.neg(t));return n.sub(r).divBy(n.add(r).mult(C.I))};C.sec=function(e){var t=e.mult(C.I);return C.TWO.divBy(C.exp(t).add(C.exp(C.neg(t))))};C.csc=function(e){var t=e.mult(C.I);return C.TWO_I.divBy(C.exp(t).sub(C.exp(C.neg(t))))};C.cot=function(e){var t=e.mult(C.I),n=C.exp(t),r=C.exp(C.neg(t));return n.add(r).mult(C.I).divBy(n.sub(r))};C.arccos=function(e){return C.I.mult(C.log(e.add(C.NEG_I.mult(C.sqrt(C.ONE.sub(e.rPow(2)))))))};C.arcsin=function(e){return C.NEG_I.mult(C.log(e.mult(C.I).add(C.sqrt(C.ONE.sub(e.rPow(2))))))};C.arctan=function(e){var t=C.I;return t.mult(C.log(t.add(e).divBy(t.sub(e)))).divBy(C.TWO)};C.arcsec=function(e){return C.NEG_I.mult(C.log(e.rPow(-1).add(C.sqrt(C.ONE.sub(C.I.divBy(e.rPow(2)))))))};C.arccsc=function(e){return C.NEG_I.mult(C.log(C.I.divBy(e).add(C.sqrt(C.ONE.sub(e.rPow(-2))))))};C.arccot=function(e){var t=C.I;return t.mult(C.log(e.sub(t).divBy(e.add(t)))).divBy(C.TWO)};C.cosh=function(e){return C.exp(e).add(C.exp(C.neg(e))).divBy(C.TWO)};C.sinh=function(e){return C.exp(e).sub(C.exp(C.neg(e))).divBy(C.TWO)};C.tanh=function(e){var t=C.exp(e),n=C.exp(C.neg(e));return t.sub(n).divBy(t.add(n))};C.sech=function(e){return C.TWO.divBy(C.exp(e).add(C.exp(C.neg(e))))};C.csch=function(e){return C.TWO.divBy(C.exp(e).sub(C.exp(C.neg(e))))};C.coth=function(e){var t=C.exp(e),n=C.exp(C.neg(e));return t.add(n).divBy(t.sub(n))};C.arccosh=function(e){return C.log(e.add(C.sqrt(e.rPow(2).sub(C.ONE))))};C.arcsinh=function(e){return C.log(e.add(C.sqrt(e.rPow(2).add(C.ONE))))};C.arctanh=function(e){return C.log(C.ONE.add(e).divBy(C.ONE.sub(e))).divBy(C.TWO)};C.arcsech=function(e){return C.log(C.ONE.add(C.sqrt(C.ONE.sub(e.rPow(2)))).divBy(e))};C.arccsch=function(e){return C.log(C.ONE.add(C.sqrt(C.ONE.add(e.rPow(2)))).divBy(e))};C.arccoth=function(e){return C.log(e.add(C.ONE).divBy(e.sub(C.ONE))).divBy(C.TWO)};C.min=function(){var e=[].slice.call(arguments).map(function(e){return e.m}),t=n.min.apply(n,e);return arguments[e.indexOf(t)]};C.max=function(){var e=[].slice.call(arguments).map(function(e){return e.m}),t=n.max.apply(n,e);return arguments[e.indexOf(t)]};C.isNaN=function(e){return isNaN(e.r)||isNaN(e.i)||isNaN(e.m)||isNaN(e.t)};C.isFinite=function(e){return isFinite(e.m)};C.formatFunction=function(e){return e.replace(a,k)};D.prototype=[];D.prototype.push=function(){return Array.prototype.push.apply(this,arguments)-1};D.prototype.Complex=C;C.parseFunction=function(e,t,n){e=e.toLowerCase();if(!n){e=C.formatFunction(e)}var r=L(t=t||[]),i=new D,s=P(e,r,i),o=t.map(function(e){return r[e]}).join(",");return(new Function(o,"var C=this.Complex;return "+s+";")).bind(i)};if(typeof module!=="undefined"&&module!==null&&module.exports){module.exports=C}else{t.Complex=C}})(typeof global==="undefined"?this:global)